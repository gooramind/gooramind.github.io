<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Victoria - Google Login</title>
  <style>
    canvas { border: 1px solid black; width: 100%; height: 100%; }
    #gameUI { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    #loginButtonContainer {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
    }
    
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .error-message {
      color: red;
      margin-top: 10px;
    }

    .user-info {
      margin-top: 10px;
      color: green;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  
  <div id="loginButtonContainer">
    <button id="signInButton">Sign in with Google</button>
    <div id="userInfo" class="user-info"></div>
    <div id="errorMessage" class="error-message"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBAdbPhKDmCuTcaMzUxHvstrc5zzFtNt9c",
    authDomain: "project-victoria-ead31.firebaseapp.com",
    projectId: "project-victoria-ead31",
    storageBucket: "project-victoria-ead31.firebasestorage.app",
    messagingSenderId: "987936519895",
    appId: "1:987936519895:web:b3ab4ca7ec25d7d7c5a292",
    measurementId: "G-YTBNKCTXK8"
  };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    
    provider.setCustomParameters({
      prompt: 'select_account'
    });

    // 브라우저 지속성 설정
    await setPersistence(auth, browserLocalPersistence);

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      console.error(message);
    }

    function updateUserInfo(user) {
      const userInfoDiv = document.getElementById('userInfo');
      if (user) {
        userInfoDiv.textContent = `로그인됨: ${user.email}`;
        document.getElementById('signInButton').textContent = '로그아웃';
      } else {
        userInfoDiv.textContent = '';
        document.getElementById('signInButton').textContent = 'Google로 로그인';
      }
    }

    async function handleAuthOperation() {
      const user = auth.currentUser;
      
      if (user) {
        // 로그아웃
        try {
          await auth.signOut();
          updateUserInfo(null);
          console.log('로그아웃 성공');
        } catch (error) {
          showError('로그아웃 실패: ' + error.message);
        }
      } else {
        // 로그인
        try {
          document.getElementById('errorMessage').textContent = '';
          
          const result = await signInWithPopup(auth, provider);
          console.log("Firebase 인증 성공:", result.user);
          
          const idToken = await result.user.getIdToken();
          console.log("ID Token obtained");
          
          // Cloudflare Worker로 토큰 전송
          try {
            const response = await fetch('https://victoria.doopyo85.su65661701.dev/auth', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ 
                token: idToken,
                email: result.user.email
              })
            });

            const data = await response.json();
            console.log("서버 응답:", data);
            
            if (response.ok) {
              console.log("서버 인증 성공:", data);
              updateUserInfo(result.user);
              location.href = "lobby.html";
            } else {
              throw new Error(data.error || '서버 인증 실패');
            }
          } catch (serverError) {
            console.error("서버 통신 오류:", serverError);
            // 서버 오류가 발생해도 Firebase 인증은 성공한 것으로 처리
            updateUserInfo(result.user);
            location.href = "lobby.html";
          }
        } catch (error) {
          console.error("로그인 오류:", error);
          
          let errorMessage = "로그인 실패";
          switch (error.code) {
            case 'auth/popup-blocked':
              errorMessage = "팝업이 차단되었습니다. 팝업 차단을 해제해주세요.";
              break;
            case 'auth/cancelled-popup-request':
              errorMessage = "로그인이 취소되었습니다.";
              break;
            case 'auth/popup-closed-by-user':
              errorMessage = "로그인 창이 닫혔습니다.";
              break;
            case 'auth/unauthorized-domain':
              errorMessage = "이 도메인에서의 로그인이 허용되지 않았습니다.";
              break;
            case 'auth/operation-not-allowed':
              errorMessage = "Google 로그인이 Firebase Console에서 활성화되지 않았습니다.";
              break;
            default:
              errorMessage = `로그인 오류: ${error.message}`;
          }
          
          showError(errorMessage);
        }
      }
    }

    // 로그인/로그아웃 버튼 이벤트 리스너
    document.getElementById('signInButton').addEventListener('click', handleAuthOperation);

    // 인증 상태 변경 감지
    auth.onAuthStateChanged((user) => {
      updateUserInfo(user);
      if (user) {
        console.log('로그인된 사용자:', user.email);
      } else {
        console.log('로그인된 사용자 없음');
      }
    });
  </script>
</body>
</html>
